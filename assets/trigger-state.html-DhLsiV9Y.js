import{_ as p,r as e,o as u,c,a as s,b as a,w as t,d as o,e as r}from"./app-sKDtX2xl.js";const l="/node-red-contrib-home-assistant-websocket/assets/jsonata_4_1-CfZXdRrw.png",k={},i=r('<h1 id="trigger-state" tabindex="-1"><a class="header-anchor" href="#trigger-state" aria-hidden="true">#</a> Trigger: state</h1><p>The <strong>Trigger: state</strong> node is very similar to the <em>Events: state</em> node. It will trigger when a given entity state changes, but unlike the <em>Events: state</em>, the <em>Trigger: state</em> node has the opportunity to add conditions using UI fields to construct complex tests. This removes much of the need to manage conditional tests using JSONata.</p><p>JSONata <em>can</em> be used in several places within this node. However real practical use is quite limited. Although the Trigger node has extensive conditional testing included as UI setting, it does not have access to the $entity() or $entities() function in the conditions. The example given here is rather simplistic and contrived to demonstrate that JSONata can be used, rather than focusing on a genuinue or realistic use-case.</p><p><img src="'+l+`" alt="screenshot"></p><p><strong>Example:</strong> Respond every five minutes during the hour before and hour after sunset.</p><div class="language-json" data-ext="json"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Trigger: state node - respond to state changes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;style&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;label&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#000000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;nodes&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;320b22abb5a9ea96&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;da88972398c7ed97&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;c2d9f44ffe436dcc&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2144de490d4257d7&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;94ceadbce4b45cdf&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;79b056d9779ec8f1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;360fe19e1e203539&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;247cbab5f584ea63&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0509fc220ff7735e&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;8fc293f5015dd3d5&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1359</span><span class="token punctuation">,</span><span class="token property">&quot;w&quot;</span><span class="token operator">:</span><span class="token number">872</span><span class="token punctuation">,</span><span class="token property">&quot;h&quot;</span><span class="token operator">:</span><span class="token number">302</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;320b22abb5a9ea96&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;inject&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Testing&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;props&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;repeat&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;crontab&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;once&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;onceDelay&quot;</span><span class="token operator">:</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token property">&quot;topic&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;payload&quot;</span><span class="token operator">:</span><span class="token string">&quot;{\\t   \\&quot;entity_id\\&quot;: \\&quot;sensor.time_utc\\&quot;,\\t   \\&quot;old_state\\&quot;: {\\&quot;state\\&quot;: \\&quot;16:49\\&quot;},\\t   \\&quot;new_state\\&quot;: {\\&quot;state\\&quot;: \\&quot;16:50\\&quot;}\\t}&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;payloadType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1400</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;da88972398c7ed97&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;da88972398c7ed97&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;trigger-state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Actions around sunset&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">&quot;inputs&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">&quot;exposeAsEntityConfig&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token string">&quot;sensor.time_utc&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;entityIdType&quot;</span><span class="token operator">:</span><span class="token string">&quot;exact&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;debugEnabled&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;constraints&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;this_entity&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetValue&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;current_state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyValue&quot;</span><span class="token operator">:</span><span class="token string">&quot;new_state.state&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorType&quot;</span><span class="token operator">:</span><span class="token string">&quot;includes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorValueDatatype&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorValue&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t/* UTC sunrise &amp; sunset to 5 mins, month average (London UK) */\\t/* Jan-Dec, Feb-Nov, Mar-Oct, Apr-Sep, May-Aug, Jun-Jly      */\\t    $times:=[[\\&quot;07:55\\&quot;, \\&quot;16:20\\&quot;],\\t             [\\&quot;07:15\\&quot;, \\&quot;16:45\\&quot;],\\t             [\\&quot;06:00\\&quot;, \\&quot;17:35\\&quot;],\\t             [\\&quot;05:15\\&quot;, \\&quot;18:30\\&quot;],\\t             [\\&quot;04:30\\&quot;, \\&quot;19:30\\&quot;],\\t             [\\&quot;04:05\\&quot;, \\&quot;20:05\\&quot;]];\\t\\t/* get this month (Jan=0), lookup sun-times table, return sun rise-set for this month */\\t    $mtable:=[0..11].$min([$, $abs($-11)]);\\t    $mindex:=$now(&#39;[M]&#39;).$number()-1;\\t\\t/* get sunset and build array of condition test-times around this */\\t    $sunset:=($times[$mtable[$mindex]])[1];\\t    $h:=$number($substringBefore($sunset, \\&quot;:\\&quot;));\\t    $m:=$number($substringAfter($sunset, \\&quot;:\\&quot;));\\t\\t/* for span period mins, generate array of times and select every nth */\\t    $span:=60;\\t    $nth:=5;\\t\\t    $t:=$h*60+$m-$span;\\t    ([$t..$t+$span*2])#$i.(\\t        $h:=$floor($/60);\\t        $m:=$%60;\\t        $i%$nth=0 ? $formatInteger($h,&#39;99&#39;) &amp; \\&quot;:\\&quot; &amp; $formatInteger($m, &#39;99&#39;);\\t    )\\t)&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;customOutputs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;messageType&quot;</span><span class="token operator">:</span><span class="token string">&quot;custom&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageValue&quot;</span><span class="token operator">:</span><span class="token string">&quot;(\\t    $sunset:=$entities(&#39;sensor.sun_next_setting&#39;).state;\\t    $togo:= ($toMillis($sunset)-$millis())/60000~&gt;$floor();\\t    $toset:= $togo &lt; 180 ? $togo : $togo-1440;\\t    $x:= $toset-25;\\t    $pc:= $x&lt;0 and $x&gt;-55 ? $min([$abs($x)*2, 100]) : null;\\t\\t    {\\&quot;topic\\&quot;: \\&quot;Minutes to Sunset\\&quot;,\\t     \\&quot;payload\\&quot;: $toset,\\t     \\&quot;time\\&quot;: $entities(&#39;sensor.time&#39;).state,\\t     \\&quot;sunset\\&quot;: $sunset,\\t     \\&quot;percent\\&quot;: $pc\\t    }\\t)&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;messageValueType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorPropertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;always&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorPropertyValue&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorType&quot;</span><span class="token operator">:</span><span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorValue&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;comparatorValueDataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;outputInitially&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;enableInput&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1440</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;c2d9f44ffe436dcc&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;2144de490d4257d7&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;247cbab5f584ea63&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;c2d9f44ffe436dcc&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Every 5 mins around sunset&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">580</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1400</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2144de490d4257d7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;switch&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Sunset Actions&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;btwn&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;vt&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v2&quot;</span><span class="token operator">:</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v2t&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;btwn&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v&quot;</span><span class="token operator">:</span><span class="token string">&quot;10&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;vt&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v2&quot;</span><span class="token operator">:</span><span class="token string">&quot;14&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v2t&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;btwn&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;vt&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v2&quot;</span><span class="token operator">:</span><span class="token string">&quot;-30&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;v2t&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;else&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;checkall&quot;</span><span class="token operator">:</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;repair&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">540</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1480</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;94ceadbce4b45cdf&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;79b056d9779ec8f1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;360fe19e1e203539&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;94ceadbce4b45cdf&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;At Sunset&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">780</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1440</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;79b056d9779ec8f1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Just Before&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">790</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1500</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;360fe19e1e203539&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Just After&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;active&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tosidebar&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;console&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;tostatus&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;complete&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;targetType&quot;</span><span class="token operator">:</span><span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusVal&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;statusType&quot;</span><span class="token operator">:</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">780</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1560</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;247cbab5f584ea63&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Brightness 0-100% over 50 min&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;pt&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;{\\t    \\&quot;domain\\&quot;: \\&quot;homeassistant\\&quot;,\\t    \\&quot;service\\&quot;: \\&quot;turn_on\\&quot;,\\t    \\&quot;target\\&quot;: {\\t        \\&quot;entity_id\\&quot;: [\\&quot;light.front_door\\&quot;, \\&quot;switch.hall_light\\&quot;]\\t        },\\t    \\&quot;data\\&quot;: {\\t        \\&quot;brightness_pct\\&quot;: percent\\t    }\\t}&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tot&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;action&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;reg&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">310</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1620</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;8fc293f5015dd3d5&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;0509fc220ff7735e&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;api-call-service&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;server&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">&quot;debugenabled&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;domain&quot;</span><span class="token operator">:</span><span class="token string">&quot;homeassistant&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;service&quot;</span><span class="token operator">:</span><span class="token string">&quot;turn_on&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;areaId&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;deviceId&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;data&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;dataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;jsonata&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;mergeContext&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;mustacheAltTags&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputProperties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;queue&quot;</span><span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">760</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1620</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;8fc293f5015dd3d5&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;switch&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;z&quot;</span><span class="token operator">:</span><span class="token string">&quot;776c027950fc8c3f&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;3a2face9747195a7&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Not null&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;property&quot;</span><span class="token operator">:</span><span class="token string">&quot;payload.data.brightness_pct&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;propertyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;t&quot;</span><span class="token operator">:</span><span class="token string">&quot;nnull&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;checkall&quot;</span><span class="token operator">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;repair&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;outputs&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;x&quot;</span><span class="token operator">:</span><span class="token number">540</span><span class="token punctuation">,</span><span class="token property">&quot;y&quot;</span><span class="token operator">:</span><span class="token number">1620</span><span class="token punctuation">,</span><span class="token property">&quot;wires&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;0509fc220ff7735e&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><p>Sunrise and sunset times are often critical to running automations, and Home Assistant has inbuilt entities that provide the next dawn, sunrise, dusk, and sunset times. In order to be able to respond to <em>multiple</em> events during the period both before and after sunset, it is necessary to trigger at a more regular interval, not just on the sun-events, and then to test for required times or periods before and after sunset.</p><p>The <em>Trigger: state</em> node can be set to use the <code>sensor.time_utc</code> entity as the subject of the node. This sensor holds UTC time as &quot;hh:mm&quot;, and will change every minute, thus triggering a state change at regular 60 second intervals. We can add conditions to test the time against an <em>expected</em> period around sunset, and to generate a <em>customised output</em> that includes given periods or times before or after sunset. Combined with a <em>Switch</em> node this permits multiple tests and multiple automation events to be actioned.</p><h3 id="using-jsonata-to-set-a-condition-value" tabindex="-1"><a class="header-anchor" href="#using-jsonata-to-set-a-condition-value" aria-hidden="true">#</a> Using JSONata to set a <em>condition value</em></h3><p>Here JSONata is used to generate an array of times of interest. When the trigger entity state, UTC time &quot;hh:mm&quot;, is included in the calculated array, the condition is met and a message will be output.</p><p>Since JSONata does not have access to the $entities() function in this particular UI field, the code here is used to generate a period of interest based on hard-coded sunrise and sunset times according to the current month. This is not ideal, but does demonstrate how JSONata can be used to easily generate and manipulate various JSON structures.</p><div class="language-text" data-ext="text"><pre class="language-text"><code>(
/* UTC sunrise &amp; sunset to 5 mins, month average (London UK) */
/* Jan-Dec, Feb-Nov, Mar-Oct, Apr-Sep, May-Aug, Jun-Jly      */
    $times:=[[&quot;07:55&quot;, &quot;16:20&quot;],
             [&quot;07:15&quot;, &quot;16:45&quot;],
             [&quot;06:00&quot;, &quot;17:35&quot;],
             [&quot;05:15&quot;, &quot;18:30&quot;],
             [&quot;04:30&quot;, &quot;19:30&quot;],
             [&quot;04:05&quot;, &quot;20:05&quot;]];

/* get this month (Jan=0), lookup sun-times table, return sun rise-set for this month */
    $mtable:=[0..11].$min([$, $abs($-11)]);
    $mindex:=$now(&#39;[M]&#39;).$number()-1;

/* get sunset and build array of condition test-times around this */
    $sunset:=($times[$mtable[$mindex]])[1];
    $h:=$number($substringBefore($sunset, &quot;:&quot;));
    $m:=$number($substringAfter($sunset, &quot;:&quot;));

/* for span period mins, generate array of times and select every nth */
    $span:=60;
    $nth:=5;

    $t:=$h*60+$m-$span;
    ([$t..$t+$span*2])#$i.(
        $h:=$floor($/60);
        $m:=$%60;
        $i%$nth=0 ? $formatInteger($h,&#39;99&#39;) &amp; &quot;:&quot; &amp; $formatInteger($m, &#39;99&#39;);
    )
)
</code></pre></div><p>This code uses the current month to lookup a given sunset time, and then to generate an array of times either side of expected sunset, using a given span in minutes, and then picking out every five minutes only.</p><p><em>The figures provided are examples, based on UTC times (DST ignored) for location London, UK and estimate an average sunrise and sunset time for each calendar month. Since sun events can move by up to one hour from start to end of a month, a span of at least 30 minutes is required to successfully include events across the entire month.</em></p><h3 id="using-jsonata-to-create-a-custom-message" tabindex="-1"><a class="header-anchor" href="#using-jsonata-to-create-a-custom-message" aria-hidden="true">#</a> Using JSONata to create a <em>custom message</em></h3><p>The output properties on successful trigger include a default message and a default payload, which includes the basic event details for the trigger entity. It is possible to set the output as a <em>customised payload</em>, which replaces msg.payload with specific output, or as a <em>customised message</em>, which replaces the entire message with a generated object.</p><div class="language-text" data-ext="text"><pre class="language-text"><code>(
    $sunset:=$entities(&#39;sensor.sun_next_setting&#39;).state;
    $togo:= ($toMillis($sunset)-$millis())/60000~&gt;$floor();
    $toset:= $togo &lt; 180 ? $togo : $togo-1440;
    $x:= $toset-25;
    $pc:= $x&lt;0 and $x&gt;-55 ? $min([$abs($x)*2, 100]) : null;

    {&quot;topic&quot;: &quot;Minutes to Sunset&quot;,
     &quot;payload&quot;: $toset,
     &quot;time&quot;: $entities(&#39;sensor.time&#39;).state,
     &quot;sunset&quot;: $sunset,
     &quot;percent&quot;: $pc
    }
)
</code></pre></div><p>The <code>$entities()</code> function is available in JSONata in the output properties UI field, which means that both current time and sunset time can be obtained and compared. This allows some simple JSONata code to generate a complete message object, including <em>msg.topic</em> and <em>msg.payload</em> with the exact minutes to the next sunset correctly calculated.</p><p>For automation, all that is required is a following <em>Switch</em> node set to route on a message property, for example <em>msg.payload</em> as minutes to next sunset between 0 and 4 (based on a five minute trigger interval) so as to be able to run an automation just as sunset is about to take place (with a five minute discrimination).</p><p>As a further example, the JSONata output calculates a percentage value going from 0 to 100 over the period 25 minutes before to 25 minutes after sunset, with the percentage value set to &#39;null&#39; outside this time. The <em>Change</em> node following also uses JSONata to create the entire <em>Service Call</em> node input settings, to turn on a group of lights in an timed-incremental fashion.</p><p><strong>Also see:</strong></p>`,21);function q(g,y){const n=e("RouterLink");return u(),c("div",null,[i,s("ul",null,[s("li",null,[a(n,{to:"/cookbook/guide/jsonata.html"},{default:t(()=>[o("JSONata guide")]),_:1})]),s("li",null,[a(n,{to:"/cookbook/guide/jsonata-primer.html"},{default:t(()=>[o("JSONata primer")]),_:1})])])])}const m=p(k,[["render",q],["__file","trigger-state.html.vue"]]);export{m as default};
